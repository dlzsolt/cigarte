<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smoke Less ‚Äì Spacing Plan</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="A simple plan to reduce smoking by spacing cigarettes.">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <h1>Smoke Less</h1>
    </header>

    <main>
        <!-- TAB 1: TRACKER -->
        <div id="tab-track" class="tab-content active">
            <!-- Rest Day Toggle -->
            <div class="toggle-container">
                <label class="toggle-label">
                    <input type="checkbox" id="rest-day-toggle">
                    <span class="toggle-text">üèñÔ∏è Rest Day Mode</span>
                </label>
            </div>

            <!-- Timer Status -->
            <div class="timer-card">
                <p id="timer-text">Ready</p>
                <div id="countdown">00:00:00</div>
            </div>

            <!-- Main Action -->
            <button id="smoke-btn" class="btn-primary btn-large">
                üö¨ Smoke One
            </button>

            <!-- Secondary Actions -->
            <button id="breathe-btn" class="btn-secondary" style="background-color: #0288D1; margin-bottom: 25px; margin-top: 0;">
                üßò Panic / Breathe
            </button>

            <!-- Dashboard Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">Today</span>
                    <span class="stat-value" id="count">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Allowed</span>
                    <span class="stat-value" id="remaining">5</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">In Pocket</span>
                    <span class="stat-value" id="pack-count-display">20</span>
                </div>
            </div>

            <!-- Weekly Chart -->
            <section class="card">
                <h2>üìä Last 7 Days</h2>
                <div id="weekly-chart" class="chart-container">
                    <!-- Bars injected by JS -->
                    <p style="text-align:center; color:#999; font-size:0.8rem;">No history yet. Check back tomorrow!</p>
                </div>
            </section>
            
            <button id="reset-btn" class="btn-text">Reset Daily Count</button>
        </div>

        <!-- TAB 2: WALLET -->
        <div id="tab-wallet" class="tab-content">
            <section class="card">
                <h2>üì¶ Pocket Manager</h2>
                <div class="pocket-actions">
                    <p class="pocket-status"><span id="pack-count">20</span> cigarettes left</p>
                    <button id="buy-pack-btn" class="btn-secondary">
                        + Buy New Pack (20)
                    </button>
                </div>
            </section>

            <section class="card">
                <h2>üí∞ Savings Calculator</h2>
                <div class="input-group">
                    <label for="pack-price">Price per pack:</label>
                    <input type="number" id="pack-price" placeholder="0.00">
                </div>
                <div id="savings-display" class="savings-results">
                    <p>Enter price to see savings.</p>
                </div>
            </section>
        </div>

        <!-- TAB 3: GUIDE -->
        <div id="tab-guide" class="tab-content">
            <section class="card">
                <h2>Daily Routine</h2>
                <ul class="info-list">
                    <li><strong>‚òÄÔ∏è Wake up:</strong> 07:00</li>
                    <li><strong>üíº Work:</strong> 5‚Äì6 hours</li>
                    <li><strong>üè† Free time:</strong> 9‚Äì10 hours</li>
                    <li><strong>üåô Sleep:</strong> 22:00</li>
                </ul>
            </section>

            <section class="card">
                <h2>The Plan</h2>
                <div class="rule-item">
                    <h3>üö´ Stop Chain Smoking</h3>
                    <p>No two cigarettes within 30 mins.</p>
                </div>
                <div class="rule-item">
                    <h3>‚è≥ Spacing</h3>
                    <p>1 cigarette every 2 hours during free time.</p>
                </div>
                <div class="summary-box">
                    <p>Goal: <strong>4‚Äì5 cigs/day</strong></p>
                    <p>Result: <strong>15‚Äì16 left</strong> in pack</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('tab-track')">
            <span class="nav-indicator">
                <span class="material-symbols-rounded">schedule</span>
            </span>
            <span class="nav-label">Track</span>
        </button>
        <button class="nav-item" onclick="switchTab('tab-wallet')">
             <span class="nav-indicator">
                <span class="material-symbols-rounded">account_balance_wallet</span>
             </span>
            <span class="nav-label">Wallet</span>
        </button>
        <button class="nav-item" onclick="switchTab('tab-guide')">
             <span class="nav-indicator">
                <span class="material-symbols-rounded">menu_book</span>
             </span>
            <span class="nav-label">Guide</span>
        </button>
        <button class="nav-item" onclick="switchTab('tab-settings')">
             <span class="nav-indicator">
                <span class="material-symbols-rounded">settings</span>
             </span>
            <span class="nav-label">Sync</span>
        </button>
    </nav>

    <!-- TAB 4: SETTINGS (SYNC) -->
    <div id="tab-settings" class="tab-content">
        <section class="card">
            <h2>‚öôÔ∏è Preferences</h2>
            <div class="input-group-stack">
                <label>Pack Size (Default 20)</label>
                <input type="number" id="pref-pack-size" placeholder="20">
            </div>
            
            <h3>üíº Work Schedule</h3>
            <div class="input-group-stack">
                <label>Work Start Time</label>
                <input type="time" id="work-start">
            </div>
            <div class="input-group-stack">
                <label>Work End Time</label>
                <input type="time" id="work-end">
            </div>
            <div class="input-group-stack">
                <label>Break Time (Smoke Allowed)</label>
                <input type="time" id="work-break">
            </div>
            <p style="font-size: 0.8rem; color: #666;">During break time, the 2-hour limit is relaxed.</p>
            
            <button id="save-prefs-btn" class="btn-primary" style="margin-top: 15px;">Save Preferences</button>
            
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3>üîî Notifications</h3>
                <button id="enable-notify-btn" class="btn-secondary" style="background-color: #7E57C2;">Enable Notifications</button>
                <p id="notify-status" style="font-size: 0.8rem; color: #666; margin-top: 5px;">Get alerted when you can smoke.</p>
                
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                     <label class="toggle-label">
                        <input type="checkbox" id="test-mode-toggle">
                        <span class="toggle-text">üß™ Test Mode (10s Timer)</span>
                    </label>
                    <p style="font-size: 0.8rem; color: #666;">Reduces timer to 10 seconds to test notifications.</p>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>‚òÅÔ∏è Cloud Sync</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                Sync your data across devices using Supabase.
            </p>

            <div id="sync-setup-form">
                <div class="input-group-stack">
                    <label>Supabase URL</label>
                    <input type="text" id="sb-url" placeholder="https://xyz.supabase.co">
                </div>
                <div class="input-group-stack">
                    <label>Supabase Anon Key</label>
                    <input type="password" id="sb-key" placeholder="eyJh...">
                </div>
                <button id="save-config-btn" class="btn-primary">Connect</button>
            </div>

            <div id="sync-auth-form" class="hidden">
                <div class="status-badge" id="connection-status">üü¢ Connected</div>
                
                <div id="auth-inputs">
                    <div class="input-group-stack">
                        <label>Email</label>
                        <input type="email" id="auth-email" placeholder="you@example.com">
                    </div>
                    <div class="input-group-stack">
                        <label>Password</label>
                        <input type="password" id="auth-password" placeholder="********">
                    </div>
                    <div class="auth-buttons">
                        <button id="login-btn" class="btn-secondary">Log In</button>
                        <button id="signup-btn" class="btn-text">Sign Up</button>
                    </div>
                </div>

                <div id="user-info" class="hidden" style="text-align: center;">
                    <p>Logged in as: <strong id="user-email-display"></strong></p>
                    <button id="logout-btn" class="btn-text" style="color: var(--danger);">Log Out</button>
                    <button id="force-sync-btn" class="btn-secondary">Force Sync Now</button>
                </div>
            </div>
        </section>
        
        <section class="card">
            <h2>‚ÑπÔ∏è How to set up</h2>
            <ol class="info-list" style="padding-left: 20px; font-size: 0.9rem;">
                <li>Go to <strong>supabase.com</strong> and create a free project.</li>
                <li>Go to <strong>Project Settings > API</strong>.</li>
                <li>Copy <strong>URL</strong> and <strong>anon public key</strong>.</li>
                <li>Paste them above and click Connect.</li>
                <li>Sign up with an email to start syncing!</li>
            </ol>
        </section>
    </div>

    <!-- Update Notification -->
    <div id="update-toast" class="update-toast hidden">
        <div class="toast-content">
            <span>New version available!</span>
            <button id="update-btn" class="btn-update">Update</button>
        </div>
    </div>

    <!-- Breathing Modal -->
    <div id="breathe-modal" class="modal hidden">
        <div class="modal-content breathe-content">
            <span id="close-breathe-x" class="close-modal">&times;</span>
            <h2>Breathe In...</h2>
            <div class="breathing-circle"></div>
            <p id="breathe-instruction">Hold...</p>
            <button id="close-breathe-btn" class="btn-text">I'm calm now</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Simple tab switching logic inline or in app.js
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show target tab
            document.getElementById(tabId).classList.add('active');
            
            // Highlight nav
            const navBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if(navBtn) navBtn.classList.add('active');
            
            // Scroll to top
            window.scrollTo(0,0);
        }

        let newWorker;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(reg => {
                    console.log('SW registered');

                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New update available
                                document.getElementById('update-toast').classList.remove('hidden');
                            }
                        });
                    });
                }).catch(err => console.error('SW failed', err));
            });

            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }

        document.getElementById('update-btn').addEventListener('click', () => {
            if (newWorker) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
            document.getElementById('update-toast').classList.add('hidden');
        });
    </script>
</body>
</html>